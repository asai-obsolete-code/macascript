(ql:quickload :alexandria)
(ql:quickload :cl-match)
(ql:quickload :anaphora)

(defpackage maca
  (:use :common-lisp :cl-user :alexandria :cl-match :anaphora))

(proclaim '(optimize (debug 3)))
(in-package :maca)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; utility

(defun not-uniquep (lst &key (test #'eq))
  (if lst
      (or (member (car lst) (cdr lst) :test test)
	  (not-uniquep (cdr lst) :test test))
      nil))

(defun not-unique (lst &key (test #'eq))
  (aif (not-uniquep lst :test test)
       (cons (car it) (not-unique (cdr lst) :test test))))
      
(defun uniquep (lst &key (test #'eq))
  (not (not-uniquep lst :test test)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; rewriter

;; helpers

(defparameter *reserved*
  '(break case catch continue default delete
    do else finally for function if in instanceof
    new return switch this throw try typeof var
    void while with 
    ;; future reserved
    abstract boolean byte char class const debugger
    double enum export extends final float goto implements
    import int interface long native package private protected
    public short static super synchronized throws transient volatile))

(defparameter *aliases*
  `((t . true)
    (on . true)
    (yes . true)
    (off . false)
    (no . false)
    (null . undefined)
    (@ . this)
	(newline . #\Newline)
	(space   . #\Space)
	(colon . #\:)
	(period . #\.)
	(semicolon . #\;)
	(comma . #\,)
	(lbrace . #\{)
	(rbrace . #\})
	(lbracket . #\[)
	(rbracket . #\])
	(lparen . #\()
	(rparen . #\)))
  "alist for aliasing the constants such as \"on\" \"yes\".")

;; core macro

(defmacro defmaca (name args &body body)
  (with-gensyms (s definition)
	`(defun ,name (,s env ,@args)
	   (let ((,definition ,@body))		;body will be evaluated first
		 (m-compile ,s env ,definition))))) ;so you can perform some bad behavior on "env". it is intentional

(defun m-glue (s env args)
  (format s "狺磲疸狎＇灬礅溽ㄡ蜱戾è趄蹂狎矧ㄣ潋ㄡ篌镢狎犰獒箦螵┅狎绌┅豉疱汜箦趄蹂狎铛祆ㄣ镱憝泔眇殪铋孱趄蹂狎绌篝蜷铉ㄦ矧磲铋④彳趄蹂狎绌ㄦ矧磲铋狺趄蹂狎绌┅┅狎珞┅ㄤ彐磲汜憝疳蝈ㄡ蜱啜珈蹂祓狎孱狎蝠狎孱┅ㄤ彐磲汜憝忪镢ㄡ蜱啜珈蹂焘蜥沐铄黛轭狎蜮蜥沐┅ㄤ彐磲汜憝泔眄ㄡ蜱螬啜珈蹂括怩綮狍磲疸犷＇灬礅溽ㄡ蜱扉篝狎с镯磲┅狎珞┅┅ㄤ彐磲汜憝箦铘孱沐箦铘螬啜珈蹂括磲疸狎＇灬礅溽箦铘啜珈蹂箦铘箦黹泔祜铄黛轭濠箦铘螬┅换换脲黠蜾ㄤ彐磲汜憝鲠鲠镳糸镱犰鲠飑啜珈蹂鲠箴徙ㄩ鲠啜鲠鲠飑鲠颟┅换换骢钽糸镱犷骢钽糸镱汜祆ㄤ彐磲汜憝骢钽糸镱汜祆镳狎珞啜珈蹂镳疳蝈ㄣ镯磲泪蜱螬┅ㄤ彐磲汜憝骢钽糸镱ㄡ蜱怙澌戾è狎珞ㄦ灬趑孱狎珞┅ㄣ镱è铒舡躅轳蹂狎珞ㄥ蝌矧痱轭趔漉痨殂狒邃狎珲礤铘孩铒舡躅轳蹂狎珞┅┅è箫礤＇灬礅溽ㄡ铒簌礅镬岍┅狎珞ㄥ蝌矧痱轭趔㈤铞犰殇狎珲礤铘┅啜珈蹂骢钽糸镱疳蝈ㄣ镯磲泪蜱螬ㄢ祀ì括怩綮狍怙澌蝈趱蝾ㄣ狎灬篝怙澌┅┅┅┅┅换换铒轫痨屙孱翦换ㄤ彐憝轭桢蜷舡翳轶骢钽糸镱ㄡ蜱怙澌换㈡躅泗轱瞑憝狎珞狎珞换憝箦铘孱沐ㄢ豸灬篝怙澌┅换憝蝈趱蝾ㄣ狎灬篝怙澌┅换换ㄤ彐憝痱镢邃躜瀛骢钽糸镱ㄡ蜱怙澌换㈡躅泗轱瞑憝狎珞狎珞换憝箦铘孱沐ㄢ豸灬篝怙澌┅换憝蝈趱蝾ㄣ狎灬篝怙澌┅换换ㄤ彐憝轭扉铄骢钽糸镱ㄡ蜱怙澌换㈡躅泗轱瞑憝狎珞狎珞换憝箦铘孱沐ㄢ豸灬篝怙澌┅换憝蝈趱蝾ㄣ狎灬篝怙澌┅换换换轸弪狒轱犷泔钿轸轱钺屮痱弩箝镱ㄤ彐磲汜憝ㄣ镱溟糸镱翳孱镳糸镱犰ㄥ祗躅溴骈铄洎啜珈蹂疳蝈泔钿轸轱瞟疳蝈翳孱泔祜疳蝈屐箦┅ㄤ彐磲汜憝屮轶舡翳轭绌啜珈蹂ā翳轭铛祆翳轭鲲殇癌┅ㄤ彐磲汜憝殒ㄣ镱溟糸镱翳孱镳糸镱犰屐箦啜珈蹂殒疳蝈泔钿轸轱瞟ㄢ祀翳孱麒孱屐箦啜屐箦ㄢ祀屐箦┅┅ㄤ彐磲汜憝轸弪狎蜥鲠狎蜥怙澌镳糸镱犰脲ㄧ孱簌愆┅戾è戾ㄧ孱簌㈧┅蝈ㄧ孱簌Ⅱ彐┅啜鲠脲鲠鲠飑鲠蝈狎蜥鲠戾ì蝈戾铉翳┅ㄧ祯骘疳蝈è脲癌脲戾瞟ǐ脲┅ㄢ祀è鲠ì蝈脲┅棱镤┅┅┅换换趄汜翥屮痱弩箝镱ㄤ彐磲汜憝趄ㄢ镤弪蝻颦鲠弪蝻镳糸镱犰骈钺祆啜珈蹂趄ㄢ祀怙澌汜翥疳蝈弪蝻颦鲠颟ㄢ祀弪蝻颟括麒孱骈钺祆啜骈钺祆ㄢ祀骈钺祆┅┅换换磲翳犷镳弪狒矧ㄤ彐疳蜥礤翦狍箝珙礤铘螵Ж技揪揪窘藿┅稽ㄤ彐磲汜憝狍箝珙礤铘镳麸骝镯啜珈蹂麸箴徙镳箴徙骝镯┅ㄤ彐疳蜥礤翦轭骈弩Ж技揪揪Ζ轭┅稽ㄤ彐磲汜憝轭骈镳鲠蝮啜疳蝈ㄧ祯ㄣ狎鲠蝮箴徙镳箴徙ㄩ翳轵鲠蝮啜镳括沅鲠蝮┅ㄣ徜鲠蝮┅┅ㄤ彐疳蜥礤翦泔眇狎轶镱螵Ж浇〗浇〗窘冀┅ㄤ彐磲汜憝泔眇狎轶镱镳鲠蝮ㄩ翳轵鲠蝮啜珈蹂疳蝈ㄧ祯ㄦ轵篝鲠蝮镳箦泔钿鲠蝮┅Ζì镳括沅鲠蝮┅啜疳蝈ㄧ祯ㄦ轵篝鲠蝮镳箦泔钿鲠蝮┅┅ㄤ彐疳蜥礤翦盹铒镳螵Ж铄箦珏豉疱镦轭篝犷沐镦鲲殇溴戾翦蝈趱蝾┅ㄤ彐磲汜憝盹铒镳镳鲠飑啜珈蹂镳箴徙鲠飑换换狎蜥犷镡赍泗扉翦蜥祗ㄤ彐躅痨轶舡麸犰轶痨轶舂灬忮祗è蝈岍ㄩ蝈ㄣ滗皓ㄣ镱ㄣ镱ㄣ狎皓ㄣ徜皓岍岍┅蝈痨轶铋飑┅ㄤ彐磲汜憝镡脲鲠祯瀛痨轶舂ㄩ镤漯戾铉翳脲鲠祯瀛痨轶舂ㄥ蝌矧㈤铞犰殇镡赍泗扉翦蜥膦戾舄è犰轶痨轶舡麸犰轶脲鲠祯瀛痨轶舂疳轵磲疸狎＇灬礅溽ㄣ镱螬啜珈蹂ㄣ狎泔铙泔祜ㄣ潋泔铙┅犰轶舂┅啜忪ㄣ镯磲鲤衢蝮┅┅ㄤ彐磲汜憝溟蝈泗徙沐篌矧镡徙沐篌矧啜珈蹂镡焘蜥汶弭ㄩㄣ潋徙沐篌矧徙沐篌矧ㄣ狎徙沐篌矧┅蜮蜥汶弭┅ㄤ彐磲汜憝徙沐篌矧镡徙沐篌矧啜珈蹂镡疱蜷镤ㄩㄣ潋徙沐篌矧徙沐篌矧ㄣ狎徙沐篌矧┅┅ㄤ彐磲汜憝屮轶舡徙沐篌矧镡徙沐篌矧脲孱戾è蝈ㄧ孱簌愆ㄣ栝熹ㄣ狎徙沐篌矧┅啜珈蹂ā疳蝈蝈ì镡汨殪洎┅铛祆ㄩㄣ潋徙沐篌矧啜蝈ㄣ潋徙沐篌矧┅蝈姗鲲殇癌┅┅ㄤ彐磲汜憝痱雉雉疱徙沐篌矧镡徙沐篌矧啜珈蹂镡疱蜷镤痱雉雉疱疱蜷镤ㄩㄣ潋徙沐篌矧徙沐篌矧ㄣ狎徙沐篌矧┅┅换换磲轭泔眇殪狒轱换麸滹换徜犷孱鲩蝻礤铘犰鲠扉徕戾换徜㈨躞舡蝈趱蝾鲠祯澧镳糸镱ㄤ彐躅憝泔眇殪孱祗舂磲泸镬弭è蝈黩轸钺礤蝈篝狎珞啜鲠祯弩ì钺礤孱泪蜱螬К钺礤┅磲翥祗换翳弩镳弪狒矧狎牾篝礤犷麸忮躞邃怡翳泔眇殪弪换滹瞌躞轸è扉篝х祯沆狨箦螬蝈黩轸憝珈蹂沆狨箦螬è扉篝ю狎孱沆狨箦蝈黩轸憝疳蝈沆狨箦┅è扉篝с镯磲沆狨箦螬蝈黩轸憝泔眄沆狨箦螬è扉篝р祀沆狨箦蝈黩轸憝忪镢沆狨箦┅è豉疱狒镯鲠飑鲠祯弩憝珈蹂孱扉篝鲠飑豉疱镦鲠飑┅è扉篝鲠豉疱簌礅镬霰┅蝈黩轸憝鲠霰┅è扉篝鲠豉疱簌礅镬霰霾蝈黩轸憝鲠霰霾┅è扉篝鲠蝈篝ㄥ蝌矧㈤铞犰殇鲠蜷徕戾钺礤┅è麒孱礤礅弪镳狍箝珙礤铘螵扉篝镳霰霾┅蝈黩轸憝狍箝珙礤铘镳霰霾┅è麒孱礤礅弪镳轭骈弩扉篝镳鲠蝮┅蝈黩轸憝轭骈镳鲠蝮┅è麒孱礤礅弪镳盹铒镳螵扉篝镳鲠颟蝈黩轸憝盹铒镳镳鲠颟è麒孱礤礅弪镳泔眇狎轶镱螵扉篝镳鲠蝮┅蝈黩轸憝泔眇狎轶镱镳鲠蝮┅è扉篝Э翳轭绌蝈黩轸憝屮轶舡翳轭绌è扉篝Э泔钿翳孱屐箦蝈黩轸憝泔钿翳孱屐箦┅换换è扉篝箦鲠鲠飑蝈黩轸憝箦鲠鲠飑è扉篝Л扉篝狎珞怙澌蝈黩轸憝骢钽糸镱狎珞怙澌┅换è扉篝Ы扉篝狎珞怙澌蝈黩轸憝轭桢蜷舡翳轶骢钽糸镱狎珞怙澌┅换è扉篝Л扉篝狎珞怙澌蝈黩轸憝痱镢邃躜瀛骢钽糸镱狎珞怙澌┅换è扉篝Л扉篝狎珞怙澌蝈黩轸憝轭扉铄骢钽糸镱狎珞怙澌┅è扉篝ф矧鲠ч狎蜥怙澌蝈黩轸憝轸弪狎蜥鲠狎蜥怙澌┅è扉篝ф矧鲠脲ч狎蜥怙澌蝈黩轸憝轸弪狎蜥鲠狎蜥怙澌脲┅换换è扉篝ф矧鲠э狎蜥蝈黩轸憝轸弪镡鲠铋狎蜥┅换换è扉篝ф矧鲠脲э狎蜥蝈黩轸憝轸弪镡鲠脲狎蜥┅换换è扉篝ф矧э黝鲠脲э狎蜥蝈黩轸憝轸弪镡鲠脲狎蜥猴黝舂è扉篝ч泔钿翳孱蝈黩轸憝殒泔钿翳孱┅è扉篝ч泔钿翳孱屐箦蝈黩轸憝殒泔钿翳孱屐箦┅è扉篝趄怙澌с狒汨扉篝弪蝻颦鲠颟弪蝻颟蝈黩轸憝趄怙澌弪蝻颦鲠弪蝻颟è扉篝趄怙澌с狒汨扉篝弪蝻颦鲠颟弪蝻ф轭犰禊骈瞟蝈黩轸憝趄怙澌弪蝻颦鲠弪蝻骈瞟è扉篝趄怙澌擤ㄥ蝌矧㈤铞犰殇趄汜翥篝狒屙孱簪┅è扉篝镡Л徙沐篌矧蝈黩轸憝溟蝈泗徙沐篌矧镡徙沐篌矧┅è扉篝镡Ь徙沐篌矧蝈黩轸憝徙沐篌矧镡徙沐篌矧┅è扉篝镡Э徙沐篌矧蝈黩轸憝屮轶舡徙沐篌矧镡徙沐篌矧┅è扉篝镡Л徙沐篌矧蝈黩轸憝痱雉雉疱徙沐篌矧镡徙沐篌矧┅è扉篝豉疱脲黠蜾脲蝈篝蝈黩轸憝镡祗舂换è聃雉è扉篝豉疱狒镯镳狎珲礤铘螬蝈黩轸憝骢钽糸镱汜祆镳狎珲礤铘螬è扉篝箦铘孱沐螬蝈黩轸憝箦铘孱沐箦铘孱沐螬┅ㄤ彐磲泸磲汜é怙澌怙澌啜痱镧ㄩ戾铉翳怙澌暴啜憝泔眇殪铋К棱镤啜憝泔眇殪铋К怙澌┅ㄦ矧磲ア┅